# AdminPlus 开发规范

## 1. 后端开发规范

### 1.1 技术选型

- **Spring Boot**: 3.5.0
- **JDK**: 21（强制使用新特性）
- **Spring Security**: 6.3+（Native JWT）
- **Spring Data JPA**: 最新版
- **PostgreSQL**: 16+
- **Lombok**: 仅用于 Entity

### 1.2 代码规范

#### DTO 使用 record 类型

**推荐：**
```java
public record UserLoginReq(
    @NotBlank String username,
    @NotBlank String password
) {}
```

**禁止：**
```java
@Data
public class UserLoginReq {
    private String username;
    private String password;
}
```

#### VO 使用 record 类型

**推荐：**
```java
public record UserVO(
    Long id,
    String username,
    String nickname,
    Instant createTime
) {}
```

#### Entity 使用 Lombok

**推荐：**
```java
@Data
@Entity
@Table(name = "sys_user")
public class UserEntity extends BaseEntity {
    @Column(name = "username")
    private String username;
}
```

#### Switch 表达式

**推荐：**
```java
var roleName = switch (roleType) {
    case "ADMIN" -> "管理员";
    case "USER" -> "普通用户";
    default -> throw new IllegalArgumentException("未知角色");
};
```

#### 虚拟线程使用

**开启虚拟线程（application.yml）：**
```yaml
spring:
  threads:
    virtual:
      enabled: true
```

**异步服务方法示例：**
```java
@Slf4j
@Service
@RequiredArgsConstructor
public class AsyncService {

    @Async
    public CompletableFuture<List<UserVO>> getUserListAsync() {
        return CompletableFuture.supplyAsync(() -> {
            log.info("使用虚拟线程处理用户列表查询");
            // IO 密集型任务
            return userList;
        });
    }
}
```

#### 树形结构处理

**构建菜单树示例：**
```java
public List<MenuVO> buildMenuTree(List<MenuVO> allMenus) {
    Map<Long, List<MenuVO>> childrenMap = new HashMap<>();

    // 按父节点分组
    for (MenuVO menu : allMenus) {
        childrenMap.computeIfAbsent(menu.parentId(), k -> new ArrayList<>()).add(menu);
    }

    // 递归构建树
    List<MenuVO> tree = new ArrayList<>();
    for (MenuVO menu : allMenus) {
        if (menu.parentId() == null || menu.parentId() == 0) {
            tree.add(buildNode(menu, childrenMap));
        }
    }

    return tree;
}

private MenuVO buildNode(MenuVO menu, Map<Long, List<MenuVO>> childrenMap) {
    List<MenuVO> children = childrenMap.getOrDefault(menu.id(), Collections.emptyList());
    return new MenuVO(
        menu.id(),
        menu.parentId(),
        menu.type(),
        menu.name(),
        menu.path(),
        menu.component(),
        menu.permKey(),
        menu.icon(),
        menu.sortOrder(),
        menu.visible(),
        menu.status(),
        buildChildren(children, childrenMap),
        menu.createTime(),
        menu.updateTime()
    );
}
```

#### 权限控制注解

**启用方法级权限控制（SecurityConfig）：**
```java
@EnableMethodSecurity
public class SecurityConfig {
    // ...
}
```

**Controller 中使用权限注解：**
```java
@PreAuthorize("hasAuthority('user:add')")
@PostMapping
public ApiResponse<UserVO> createUser(@Valid @RequestBody UserCreateReq req) {
    // ...
}

@PreAuthorize("hasRole('ADMIN')")
@DeleteMapping("/{id}")
public ApiResponse<Void> deleteUser(@PathVariable Long id) {
    // ...
}
```

#### 分页查询实现

**Repository 分页查询：**
```java
@Repository
public interface UserRepository extends JpaRepository<UserEntity, Long> {

    @Query("SELECT u FROM UserEntity u WHERE u.deleted = false")
    Page<UserEntity> findAllByDeletedFalse(Pageable pageable);
}
```

**Service 分页查询：**
```java
public PageResult<UserVO> getUserList(Integer page, Integer size, String keyword) {
    Pageable pageable = PageRequest.of(page - 1, size, Sort.by("createTime").descending());

    Specification<UserEntity> spec = (root, query, cb) -> {
        List<Predicate> predicates = new ArrayList<>();
        predicates.add(cb.equal(root.get("deleted"), false));

        if (StringUtils.hasText(keyword)) {
            predicates.add(cb.or(
                cb.like(root.get("username"), "%" + keyword + "%"),
                cb.like(root.get("nickname"), "%" + keyword + "%")
            ));
        }

        return cb.and(predicates.toArray(new Predicate[0]));
    };

    Page<UserEntity> pageResult = userRepository.findAll(spec, pageable);

    return new PageResult<>(
        pageResult.getContent().stream().map(this::toVO).toList(),
        pageResult.getTotalElements(),
        pageResult.getNumber() + 1,
        pageResult.getSize()
    );
}
```

### 1.3 包结构

```
com.adminplus
├── config/          # 配置类
├── controller/      # 控制器
├── dto/             # 数据传输对象（record）
├── entity/          # 实体类
├── exception/       # 异常处理
├── repository/      # JPA Repository
├── service/         # 服务层
│   └── impl/        # 服务实现
├── utils/           # 工具类
└── vo/              # 视图对象（record）
```

### 1.4 命名规范

#### 类名
- PascalCase（User/UserService/UserController）

#### 方法名
- 小驼峰式（getUserById/createUser/updateUser/deleteUser）

#### 变量名
- 小驼峰式（userName/currentPage/loading）

### 1.5 注解规范

#### Controller
```java
@Slf4j
@RestController
@RequestMapping("/sys/users")
@RequiredArgsConstructor
@Tag(name = "用户管理", description = "用户增删改查")
public class UserController {
    // ...
}
```

#### Service
```java
@Slf4j
@Service
@RequiredArgsConstructor
public class UserServiceImpl implements UserService {
    @Transactional
    public UserVO createUser(UserCreateReq req) {
        // ...
    }
}
```

#### Repository
```java
@Repository
public interface UserRepository extends JpaRepository<UserEntity, Long> {
    Optional<UserEntity> findByUsername(String username);
}
```

#### Entity
```java
@Data
@Entity
@Table(name = "sys_user")
public class UserEntity extends BaseEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "username", nullable = false, length = 50)
    private String username;
}
```

### 1.6 数据库规范

#### 表名
- `sys_` 前缀，小写蛇形（sys_user, sys_role）

#### 字段名
- 小写蛇形（user_name, create_time）

#### 主键
- `id`（BIGSERIAL，自增）

#### 时间字段
- `create_time`, `update_time`（TIMESTAMP WITH TIME ZONE）

#### 逻辑删除
- `deleted`（BOOLEAN，false 未删除 / true 已删除）

#### 状态字段
- `status`（INTEGER，1 正常 / 0 禁用）

### 1.7 API 规范

#### URL
- RESTful（GET/POST/PUT/DELETE）
- 资源复数形式（/sys/users, /sys/roles）

#### 请求头
```
Content-Type: application/json
Authorization: Bearer {token}
```

#### 响应格式

**使用 ApiResponse 统一封装：**
```java
// 成功响应
return ApiResponse.ok(data);
return ApiResponse.ok("操作成功", data);

// 失败响应
return ApiResponse.fail("操作失败");
return ApiResponse.fail(400, "参数错误");
```

**响应格式：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {...},
  "timestamp": 1704010000000}
```

#### 分页格式
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "records": [...],
    "total": 100,
    "page": 1,
    "size": 10
  },
  "timestamp": 1704010000000
}
```

## 2. 前端开发规范

### 2.1 技术选型

- **Vue**: 3.5+（Composition API）
- **Vite**: 6+
- **Pinia**: 3.x（Setup Store）
- **Element Plus**: 最新版
- **Axios**: HTTP 客户端
- **JavaScript**: ES2022+（不使用 TypeScript）

### 2.2 目录结构

```
src/
├── api/             # API 接口层
├── assets/          # 静态资源
├── components/      # 全局组件
├── directives/      # 自定义指令
├── layout/          # 布局组件
├── router/          # 路由配置
├── stores/          # Pinia 状态管理
├── utils/           # 工具函数
└── views/           # 页面组件
    ├── auth/        # 认证相关页面
    └── system/      # 系统管理页面
```

### 2.3 代码规范

#### 组件定义

**推荐：**
```vue
<script setup>
import { ref } from 'vue'
import { getUserList } from '@/api/user'

const loading = ref(false)
const tableData = ref([])

const getData = async () => {
  loading.value = true
  try {
    const data = await getUserList()
    tableData.value = data
  } finally {
    loading.value = false
  }
}
</script>
```

**禁止：**
```vue
<script>
export default {
  data() {
    return {
      loading: false,
      tableData: []
    }
  }
}
</script>
```

#### 变量声明

**推荐：**
```javascript
const loading = ref(false)
const tableData = ref([])
```

**禁止：**
```javascript
var loading = false
let tableData = []
```

#### 响应式

**推荐：**
```javascript
const form = ref({
  username: '',
  password: ''
})
```

**复杂表单对象可以使用 reactive：**
```javascript
const form = reactive({
  username: '',
  password: ''
})
```

### 2.4 命名规范

#### 组件文件
- PascalCase（UserList.vue, UserForm.vue）

#### 页面文件
- kebab-case（user/index.vue, role/index.vue）

#### API 文件
- kebab-case（user.js, role.js）

#### Store 文件
- kebab-case（user.js, role.js）

#### 变量命名
- 小驼峰式（userName, currentPage, loading）

#### 常量命名
- 大写+下划线（API_BASE_URL, PAGE_SIZE）

#### 函数命名
- 小驼峰式（getUserList, validateForm）

#### 事件处理
- handle 前缀（handleAdd, handleEdit, handleDelete）

#### Store 函数
- use 前缀（useUserStore, usePermissionStore）

### 2.5 Store 规范

**推荐（Setup Store）：**
```javascript
// stores/user.js
import { defineStore } from 'pinia'
import { ref } from 'vue'

export const useUserStore = defineStore('user', () => {
  const token = ref(localStorage.getItem('token') || '')
  const user = ref(null)

  const setToken = (val) => {
    token.value = val
    localStorage.setItem('token', val)
  }

  const login = async (username, password) => {
    // ...
  }

  return {
    token,
    user,
    setToken,
    login
  }
})
```

**禁止（Options Store）：**
```javascript
export const useUserStore = defineStore('user', {
  state: () => ({
    token: '',
    user: null
  }),
  actions: {
    setToken(val) {
      this.token = val
    }
  }
})
```

### 2.6 API 封装

**推荐：**
```javascript
// api/user.js
import request from '@/utils/request'

export const getUserList = (params) => {
  return request({
    url: '/sys/users',
    method: 'get',
    params
  })
}

export const createUser = (data) => {
  return request({
    url: '/sys/users',
    method: 'post',
    data
  })
}
```

### 2.7 路由规范

**推荐：**
```javascript
{
  path: '/system/user',
  name: 'SystemUser',
  component: () => import('@/views/system/User.vue'),
  meta: { title: '用户管理', requiresAuth: true }
}
```

### 2.8 组件通信规范

**父组件传递数据：**
```vue
<script setup>
import UserForm from './UserForm.vue'

const formData = ref({
  username: '',
  nickname: ''
})

const handleSubmit = (data) => {
  console.log('提交数据:', data)
}
</script>

<template>
  <UserForm v-model="formData" @submit="handleSubmit" />
</template>
```

**子组件接收和触发事件：**
```vue
<script setup>
const props = defineProps({
  modelValue: {
    type: Object,
    required: true
  }
})

const emit = defineEmits(['update:modelValue', 'submit'])

const handleChange = (key, value) => {
  emit('update:modelValue', { ...props.modelValue, [key]: value })
}

const handleSubmit = () => {
  emit('submit', props.modelValue)
}
</script>
```

### 2.9 权限指令使用

**定义权限指令：**
```javascript
// directives/auth.js
import { useUserStore } from '@/stores/user'

export default {
  mounted(el, binding) {
    const userStore = useUserStore()
    const { value } = binding

    if (value && !userStore.hasPermission(value)) {
      el.parentNode?.removeChild(el)
    }
  }
}
```

**注册权限指令：**
```javascript
// main.js
import authDirective from '@/directives/auth'

app.directive('auth', authDirective)
```

**使用权限指令：**
```vue
<template>
  <el-button v-auth="'user:add'">新增用户</el-button>
  <el-button v-auth="'user:edit'">编辑用户</el-button>
  <el-button v-auth="'user:delete'">删除用户</el-button>
</template>
```

### 2.10 自定义指令规范

**指令命名：**
- kebab-case（v-auth、v-loading、v-copy）

**指令定义：**
```javascript
// directives/copy.js
export default {
  mounted(el, binding) {
    el.addEventListener('click', () => {
      navigator.clipboard.writeText(binding.value)
      ElMessage.success('复制成功')
    })
  }
}
```

**注册指令：**
```javascript
// directives/index.js
import auth from './auth'
import copy from './copy'

export default function setupDirectives(app) {
  app.directive('auth', auth)
  app.directive('copy', copy)
}
```

## 3. Git 提交规范

### 3.1 提交格式

```
<type>(<scope>): <subject>
```

### 3.2 Type 类型

- `feat`: 新功能
- `fix`: 修复 bug
- `docs`: 文档更新
- `style`: 代码格式（不影响代码运行的变动）
- `refactor`: 重构
- `test`: 测试相关
- `chore`: 构建过程或辅助工具的变动

### 3.3 Scope 范围

- `user`: 用户模块
- `role`: 角色模块
- `menu`: 菜单模块
- `auth`: 认证模块
- `common`: 公共模块

### 3.4 示例

```bash
feat(user): 添加用户批量删除功能
fix(role): 修复角色分配权限时的 bug
docs(readme): 更新 README 文档
style(user): 统一代码格式
refactor(auth): 重构 JWT 认证逻辑
test(user): 添加用户单元测试
chore(deps): 升级 Spring Boot 版本
```

## 4. 代码审查要点

### 4.1 后端审查要点

- [ ] DTO 是否使用 record 类型
- [ ] 是否使用 Switch 表达式
- [ ] Service 方法是否添加 @Transactional
- [ ] 是否统一异常处理
- [ ] 是否统一返回格式
- [ ] 是否遵循包结构规范
- [ ] 是否遵循命名规范
- [ ] 是否添加必要的注释

### 4.2 前端审查要点

- [ ] 组件是否使用 `<script setup>`
- [ ] 变量是否使用 const 声明
- [ ] Store 是否使用 Setup Store
- [ ] 是否遵循目录结构规范
- [ ] 是否遵循命名规范
- [ ] 是否添加必要的注释
- [ ] 是否处理 loading 状态
- [ ] 是否处理错误情况

## 5. 注意事项

1. **前端不使用 TypeScript**
2. **数据库表统一使用 sys_ 前缀**
3. **API 统一返回格式**
4. **分页数据使用 records、total、page、size**
5. **时间字段统一使用 create_time 和 update_time**
6. **逻辑删除统一使用 deleted 字段**
7. **状态字段统一使用 status（1 正常 / 0 禁用）**
8. **DTO 和 VO 必须使用 record 类型**

## 6. 性能优化规范

### 6.1 后端性能优化

#### 数据库查询优化

**避免 N+1 查询问题：**
```java
// ❌ 错误：N+1 查询
public List<UserVO> getUserList() {
    List<UserEntity> users = userRepository.findAll();
    return users.stream().map(user -> {
        List<RoleEntity> roles = userRoleRepository.findByUserId(user.getId());
        return toVO(user, roles);
    }).toList();
}

// ✅ 正确：使用 JOIN 查询
@Query("SELECT u FROM UserEntity u LEFT JOIN FETCH u.roles WHERE u.deleted = false")
List<UserEntity> findAllWithRoles();
```

**使用缓存：**
```java
@Service
@RequiredArgsConstructor
public class DictService {

    @Cacheable(value = "dict", key = "#dictType")
    public List<DictItemVO> getDictItems(String dictType) {
        return dictItemRepository.findByDictType(dictType);
    }

    @CacheEvict(value = "dict", key = "#dictType")
    public void updateDict(String dictType) {
        // 更新后清除缓存
    }
}
```

#### 虚拟线程使用

**IO 密集型任务使用虚拟线程：**
```java
@Async
public CompletableFuture<List<UserVO>> getUserListAsync() {
    return CompletableFuture.supplyAsync(() -> {
        // 数据库查询
        return userRepository.findAll();
    });
}
```

### 6.2 前端性能优化

#### 组件懒加载

**路由懒加载：**
```javascript
{
  path: '/system/user',
  component: () => import('@/views/system/User.vue')
}
```

**组件懒加载：**
```vue
<script setup>
import { defineAsyncComponent } from 'vue'

const UserForm = defineAsyncComponent(() => import('./UserForm.vue'))
</script>
```

#### 列表虚拟滚动

**使用虚拟滚动：**
```vue
<template>
  <el-table-v2
    :columns="columns"
    :data="tableData"
    :width="700"
    :height="400"
    :row-height="50"
  />
</template>
```

#### 防抖和节流

**防抖示例：**
```javascript
import { debounce } from 'lodash-es'

const handleSearch = debounce(async (keyword) => {
  await getUserList({ keyword })
}, 300)
```

**节流示例：**
```javascript
import { throttle } from 'lodash-es'

const handleScroll = throttle(() => {
  console.log('滚动事件')
}, 100)
```

## 7. 安全规范

### 7.1 后端安全

#### SQL 注入防护

**使用 JPA 参数化查询：**
```java
// ✅ 安全：使用 JPA 方法
List<UserEntity> findByUsername(String username);

// ✅ 安全：使用 @Query 参数化查询
@Query("SELECT u FROM UserEntity u WHERE u.username = :username")
UserEntity findByUsername(@Param("username") String username);

// ❌ 危险：拼接 SQL
String sql = "SELECT * FROM sys_user WHERE username = '" + username + "'";
```

#### XSS 防护

**输入过滤：**
```java
@Service
@RequiredArgsConstructor
public class UserService {

    public UserVO createUser(UserCreateReq req) {
        // 过滤 HTML 标签
        String cleanNickname = HtmlUtils.htmlEscape(req.nickname());
        // ...
    }
}
```

#### CSRF 防护

**启用 CSRF 防护（SecurityConfig）：**
```java
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    return http
        .csrf(csrf -> csrf
            .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())
        )
        // ...
}
```

#### 敏感数据加密

**密码加密：**
```java
@Service
@RequiredArgsConstructor
public class UserService {

    private final PasswordEncoder passwordEncoder;

    public UserVO createUser(UserCreateReq req) {
        user.setPassword(passwordEncoder.encode(req.password()));
        // ...
    }
}
```

**配置文件加密：**
```yaml
# application.yml
spring:
  datasource:
    password: '{cipher}AQA...'  # 使用 Jasypt 加密
```

### 7.2 前端安全

#### XSS 防护

**使用 v-text 替代 v-html：**
```vue
<!-- ✅ 安全 -->
<div v-text="userInput"></div>

<!-- ❌ 危险 -->
<div v-html="userInput"></div>
```

**使用 DOMPurify 过滤：**
```javascript
import DOMPurify from 'dompurify'

const cleanHtml = DOMPurify.sanitize(userInput)
```

#### CSRF Token

**Axios 自动添加 CSRF Token：**
```javascript
request.interceptors.request.use(config => {
  const csrfToken = getCookie('XSRF-TOKEN')
  if (csrfToken) {
    config.headers['X-XSRF-TOKEN'] = csrfToken
  }
  return config
})
```

## 8. 测试规范

### 8.1 后端测试

#### 单元测试

**Service 单元测试：**
```java
@SpringBootTest
class UserServiceTest {

    @Autowired
    private UserService userService;

    @MockBean
    private UserRepository userRepository;

    @Test
    void testCreateUser() {
        // Given
        UserCreateReq req = new UserCreateReq("test", "123456", "测试用户", null, null, null);

        // When
        UserVO user = userService.createUser(req);

        // Then
        assertNotNull(user);
        assertEquals("test", user.username());
    }
}
```

#### 集成测试

**Controller 集成测试：**
```java
@SpringBootTest
@AutoConfigureMockMvc
class UserControllerTest {

    @Autowired
    private MockMvc mockMvc;

    @Test
    @WithMockUser(username = "admin", roles = "ADMIN")
    void testGetUserList() throws Exception {
        mockMvc.perform(get("/sys/users"))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.code").value(200));
    }
}
```

### 8.2 前端测试

#### 组件测试

**使用 Vitest 测试组件：**
```javascript
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import UserForm from '@/components/UserForm.vue'

describe('UserForm', () => {
  it('should emit submit event with form data', async () => {
    const wrapper = mount(UserForm)

    await wrapper.find('input[name="username"]').setValue('test')
    await wrapper.find('form').trigger('submit')

    expect(wrapper.emitted('submit')).toBeTruthy()
  })
})
```

## 9. 部署规范

### 9.1 Docker 部署

#### 后端 Dockerfile

```dockerfile
# Dockerfile
FROM eclipse-temurin:21-jre-alpine

WORKDIR /app

COPY target/adminplus-backend.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "app.jar"]
```

#### 前端 Dockerfile

```dockerfile
# Dockerfile
FROM node:18-alpine AS builder

WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .
RUN npm run build

FROM nginx:alpine

COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

#### docker-compose.yml

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: adminplus
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data

  backend:
    build: ./backend
    ports:
      - "8080:8080"
    depends_on:
      - postgres
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/adminplus

  frontend:
    build: ./frontend
    ports:
      - "80:80"
    depends_on:
      - backend

volumes:
  postgres-data:
```

### 9.2 环境变量配置

**后端环境变量：**
```bash
# .env.production
SPRING_DATASOURCE_URL=jdbc:postgresql://localhost:5432/adminplus
SPRING_DATASOURCE_USERNAME=postgres
SPRING_DATASOURCE_PASSWORD=your_password
JWT_SECRET=your_jwt_secret
```

**前端环境变量：**
```bash
# .env.production
VITE_API_BASE_URL=https://api.example.com
```

### 9.3 日志收集

**Logback 配置：**
```xml
<!-- logback-spring.xml -->
<appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
    <file>logs/adminplus.log</file>
    <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
        <fileNamePattern>logs/adminplus.%d{yyyy-MM-dd}.log</fileNamePattern>
        <maxHistory>30</maxHistory>
    </rollingPolicy>
</appender>
```

### 9.4 监控配置

**Actuator 端点：**
```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  metrics:
    export:
      prometheus:
        enabled: true
```